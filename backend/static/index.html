<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lost Object Finder</title>
<link rel="stylesheet" href="/static/styles.css">
</head>
<div id="darkModeToggle" class="dark-mode-toggle">ğŸŒ™</div>
<body>
<div class="container">
    <header>
        <h1>ğŸ” Lost Object Finder</h1>
        <p class="subtitle">Real-time object detection with YOLOv8 - 80 object classes</p>
    </header>

    <div class="card">
        <div class="search-container">
            <input type="text" id="objectSearch" placeholder="Search objects..." autocomplete="off">
            <div id="searchResults" class="hidden"></div>
        </div>

        <div class="video-container">
            <img id="videoFeed" src="" alt="Video feed will appear here" style="display: none;">
            <div id="placeholder" class="loading">
                <p>ğŸ‘† Objects will appear below. Hover a category to see its objects.</p>
            </div>
        </div>
        
        <div class="browse-files-container">
            <button id="browseBtn" class="main-btn browse">ğŸ“‚ Browse Files</button>
            <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
            <div id="filePreview" class="file-preview"></div>
        </div>

        <div id="status" class="status"></div>
        <div class="controls">
        </div>

        <div class="control-buttons">
            <button id="startBtn" class="main-btn start">â–¶ Start Detection</button>
            <button id="stopBtn" class="main-btn stop" disabled>â¹ Stop Detection</button>
            <button id="selectAllBtn" class="main-btn select-all">Select All</button>
            <button id="deselectAllBtn" class="main-btn deselect-all">Deselect All</button>
        </div>

        <div id="selectedObjectsContainer">
            <span id="selectedCountDisplay">Selected: 0</span>
            <div id="selectedObjectsList" class="hidden"></div>
        </div>

        <div class="categories-container" id="categoriesContainer"></div>

        <div class="objects-grid-popup" id="objectsPopup"></div>
    </div>
</div>

<script>
const categories = {
    'People & Animals': ['person', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe'],
    'Vehicles': ['bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat'],
    'Street Objects': ['traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench'],
    'Accessories': ['backpack', 'umbrella', 'handbag', 'tie', 'suitcase'],
    'Sports': ['frisbee', 'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket'],
    'Kitchen & Dining': ['bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl'],
    'Food': ['banana', 'apple', 'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake'],
    'Furniture': ['chair', 'couch', 'potted plant', 'bed', 'dining table', 'toilet'],
    'Electronics': ['tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'refrigerator'],
    'Other Objects': ['book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush', 'sink']
};

let selectedObjects = new Set();

const categoriesContainer = document.getElementById('categoriesContainer');
const popup = document.getElementById('objectsPopup');
const status = document.getElementById('status');

let activeCategory = null;

// generÄƒm categoriile
Object.entries(categories).forEach(([catName, objects]) => {
    const catDiv = document.createElement('div');
    catDiv.className = 'category';
    catDiv.textContent = catName;
    catDiv.dataset.category = catName;
    categoriesContainer.appendChild(catDiv);

    // Hover â†’ afiÈ™eazÄƒ popup
    catDiv.addEventListener('mouseover', (e) => {
        activeCategory = catDiv;
        popup.innerHTML = '';

        objects.forEach(obj => {
            const btn = document.createElement('button');
            btn.className = 'object-btn';
            btn.textContent = obj;
            btn.dataset.object = obj;
            if (selectedObjects.has(obj)) btn.classList.add('selected');
            btn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                toggleObject(obj, btn);
            });
            popup.appendChild(btn);
        });

        const rect = catDiv.getBoundingClientRect();
        popup.style.top = rect.bottom + window.scrollY + 'px';
        popup.style.left = rect.left + window.scrollX + 'px';
        popup.style.display = 'flex';
    });

    // Click pe categorie â†’ selecteazÄƒ toate / deselecteazÄƒ toate
    catDiv.addEventListener('click', (e) => {
        e.stopPropagation();
        const allSelected = objects.every(obj => selectedObjects.has(obj));

        if (allSelected) {
            objects.forEach(obj => selectedObjects.delete(obj));
            showStatus(`âŒ Deselected all ${objects.length} from ${catName}`, 'error');
        } else {
            objects.forEach(obj => selectedObjects.add(obj));
            showStatus(`âœ… Selected all ${objects.length} from ${catName}`, 'success');
        }

        document.querySelectorAll('.object-btn').forEach(btn => {
            if (objects.includes(btn.dataset.object)) {
                btn.classList.toggle('selected', selectedObjects.has(btn.dataset.object));
            }
        });
    });
});

// popup rÄƒmÃ¢ne activ cÃ¢nd treci peste el
popup.addEventListener('mouseover', () => {
    popup.style.display = 'flex';
});

popup.addEventListener('mouseout', () => {
    popup.style.display = 'none';
    activeCategory = null;
});

function toggleObject(obj, btn) {
    if (selectedObjects.has(obj)) {
        selectedObjects.delete(obj);
        btn.classList.remove('selected');
    } else {
        selectedObjects.add(obj);
        btn.classList.add('selected');
    }
}

function showStatus(message, type = 'info') {
    status.textContent = message;
    status.className = 'status ' + type;
    status.style.display = 'block';
    setTimeout(() => status.style.display = 'none', 3000);
}
// ---------------- START/STOP CAMERA ----------------
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const videoFeed = document.getElementById('videoFeed');
const placeholder = document.getElementById('placeholder');

startBtn.addEventListener('click', async () => {
    if (selectedObjects.size === 0) {
        showStatus('âš ï¸ Please select at least one object before starting.', 'error');
        return;
    }

    const target = Array.from(selectedObjects).join(',');
    videoFeed.src = `/track?target_object=${encodeURIComponent(target)}`;
    videoFeed.style.display = 'block';
    placeholder.style.display = 'none';
    startBtn.disabled = true;
    stopBtn.disabled = false;

    showStatus(`ğŸ¥ Detecting: ${target}`, 'info');
});

stopBtn.addEventListener('click', async () => {
    await fetch('/stop_camera');
    videoFeed.style.display = 'none';
    placeholder.style.display = 'block';
    videoFeed.src = '';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    showStatus('ğŸ›‘ Detection stopped.', 'error');
});
// ---------------- SELECT/DESELECT ALL ----------------
const selectAllBtn = document.getElementById('selectAllBtn');
const deselectAllBtn = document.getElementById('deselectAllBtn');

selectAllBtn.addEventListener('click', () => {
    Object.values(categories).flat().forEach(obj => selectedObjects.add(obj));
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.add('selected'));
    showStatus('âœ… All objects selected', 'success');
});

deselectAllBtn.addEventListener('click', () => {
    selectedObjects.clear();
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.remove('selected'));
    showStatus('âŒ All objects deselected', 'error');
});
const selectedCountDisplay = document.getElementById('selectedCountDisplay');
const selectedObjectsList = document.getElementById('selectedObjectsList');

// Functie pentru update numar si lista
function updateSelectedDisplay() {
    selectedCountDisplay.textContent = `Selected: ${selectedObjects.size}`;
    
    selectedObjectsList.innerHTML = '';
    selectedObjects.forEach(obj => {
        const span = document.createElement('span');
        span.textContent = obj;
        selectedObjectsList.appendChild(span);
    });
}

// Toggle lista obiecte la click pe numar
selectedCountDisplay.addEventListener('click', () => {
    selectedObjectsList.classList.toggle('hidden');
});

// Apeleaza update dupa selectare/deselectare
function toggleObject(obj, btn) {
    if (selectedObjects.has(obj)) {
        selectedObjects.delete(obj);
        btn.classList.remove('selected');
    } else {
        selectedObjects.add(obj);
        btn.classList.add('selected');
    }
    updateSelectedDisplay();
}

// Dupa click pe select all / deselect all, actualizeaza lista
selectAllBtn.addEventListener('click', () => {
    Object.values(categories).flat().forEach(obj => selectedObjects.add(obj));
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.add('selected'));
    updateSelectedDisplay();
    showStatus('âœ… All objects selected', 'success');
});

deselectAllBtn.addEventListener('click', () => {
    selectedObjects.clear();
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.remove('selected'));
    updateSelectedDisplay();
    showStatus('âŒ All objects deselected', 'error');
});

const objectSearch = document.getElementById('objectSearch');
const searchResults = document.getElementById('searchResults');

// Lista completa a obiectelor
const allObjects = Object.values(categories).flat();

// Functie pentru afisare rezultate filtrate
objectSearch.addEventListener('input', () => {
    const query = objectSearch.value.toLowerCase();
    searchResults.innerHTML = '';

    if (query === '') {
        searchResults.classList.add('hidden');
        return;
    }

    const filtered = allObjects.filter(obj => obj.toLowerCase().startsWith(query));

    if (filtered.length === 0) {
        searchResults.classList.add('hidden');
        return;
    }

    filtered.forEach(obj => {
        const span = document.createElement('span');
        span.textContent = obj;
        span.addEventListener('click', () => {
            // Adauga obiectul in selectedObjects
            selectedObjects.add(obj);

            // Actualizeaza lista vizibila si butoanele
            document.querySelectorAll('.object-btn').forEach(btn => {
                if (btn.dataset.object === obj) btn.classList.add('selected');
            });
            updateSelectedDisplay();

            // Curata search bar
            objectSearch.value = '';
            searchResults.classList.add('hidden');
        });
        searchResults.appendChild(span);
    });

    searchResults.classList.remove('hidden');
});

// Ascunde rezultatele cand se da click in afara
document.addEventListener('click', (e) => {
    if (!objectSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
    }
});

const darkModeToggle = document.getElementById('darkModeToggle');

darkModeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');

  // schimbÄƒ iconiÈ›a
  if(document.body.classList.contains('dark-mode')) {
    darkModeToggle.textContent = 'â˜€ï¸'; // luminÄƒ
  } else {
    darkModeToggle.textContent = 'ğŸŒ™'; // Ã®ntuneric
  }
});
const browseBtn = document.getElementById('browseBtn');
const fileInput = document.getElementById('fileInput');

browseBtn.addEventListener('click', () => {
    fileInput.click();
});

let fileActive = false; // marcheazÄƒ dacÄƒ un fiÈ™ier este Ã®ncÄƒrcat
let fileType = null;    // 'image' sau 'video'
let fileObjectURL = null;

fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    fileActive = true;
    fileType = file.type.startsWith('image/') ? 'image' : 'video';
    fileObjectURL = URL.createObjectURL(file);

    // Ascundem feed live
    videoFeed.style.display = 'none';
    placeholder.style.display = 'none';

    if (fileType === 'image') {
        videoFeed.src = fileObjectURL;
        videoFeed.style.display = 'block';
    } else if (fileType === 'video') {
        videoFeed.src = fileObjectURL;
        videoFeed.controls = true;
        videoFeed.autoplay = true;
        videoFeed.style.display = 'block';
    }
});

startBtn.addEventListener('click', async () => {
    if (selectedObjects.size === 0) {
        showStatus('âš ï¸ Please select at least one object before starting.', 'error');
        return;
    }

    const target = Array.from(selectedObjects).join(',');

    if (fileActive) {
        // Trimitem fiÈ™ierul la backend pentru detectie
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('target_object', target);

        try {
            const response = await fetch('/track_file', { method: 'POST', body: formData });
            const result = await response.json();
            showStatus(`ğŸ¯ Detection result: ${JSON.stringify(result)}`, 'info');
        } catch (err) {
            showStatus('âŒ Error detecting objects in file.', 'error');
        }

    } else {
        // Feed live
        videoFeed.src = `/track?target_object=${encodeURIComponent(target)}`;
        videoFeed.style.display = 'block';
        placeholder.style.display = 'none';
    }

    startBtn.disabled = true;
    stopBtn.disabled = false;
});

stopBtn.addEventListener('click', async () => {
    if (fileActive) {
        // Reset fiÈ™ier
        videoFeed.src = '';
        videoFeed.style.display = 'none';
        fileActive = false;
        fileType = null;
        fileObjectURL = null;
    }

    // Reset feed live
    videoFeed.style.display = 'block';
    placeholder.style.display = 'block';
    videoFeed.src = '';

    startBtn.disabled = false;
    stopBtn.disabled = true;

    showStatus('ğŸ›‘ Detection stopped.', 'error');
});


</script>
</body>
</html>
