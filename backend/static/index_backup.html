<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lost Object Finder</title>
<link rel="stylesheet" href="/static/styles.css">
</head>
<div id="darkModeToggle" class="dark-mode-toggle">üåô</div>
<body>
<div class="container">
    <header>
        <h1>üîç Lost Object Finder</h1>
        <p class="subtitle">Real-time object detection with YOLOv8 - 80 object classes</p>
    </header>

    <div class="card">
        <div class="search-container">
            <input type="text" id="objectSearch" placeholder="Search objects..." autocomplete="off">
            <div id="searchResults" class="hidden"></div>
        </div>

        <div class="video-container">
            <img id="videoFeed" src="" alt="Video feed will appear here" style="display: none;">
            <div id="placeholder" class="loading">
                <p>üëÜ Objects will appear below. Hover a category to see its objects.</p>
            </div>
        </div>
        
        <div id="status" class="status"></div>

        <div class="mode-selection">
            <h3>Choose Detection Mode:</h3>
            <div class="mode-buttons">
                <button id="cameraMode" class="mode-btn camera-mode">
                    üìπ Live Camera Detection
                </button>
                <button id="fileMode" class="mode-btn file-mode">
                    üìÅ Import File (Image/Video)
                </button>
            </div>
        </div>

        <!-- Camera Mode Controls -->
        <div id="cameraControls" class="mode-controls hidden">
            <h4>üé• Camera Mode</h4>
            <div class="control-buttons">
                <button id="startCameraBtn" class="main-btn start">‚ñ∂ Start Camera Detection</button>
                <button id="stopCameraBtn" class="main-btn stop" disabled>‚èπ Stop Camera</button>
            </div>
        </div>

        <!-- File Mode Controls -->
        <div id="fileControls" class="mode-controls hidden">
            <h4>üìÅ File Mode</h4>
            <div class="browse-files-container">
                <button id="browseBtn" class="main-btn browse">üìÇ Select Image or Video</button>
                <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
                <div id="filePreview" class="file-preview"></div>
            </div>
            <div class="control-buttons">
                <button id="detectFileBtn" class="main-btn start" disabled>‚ñ∂ Detect Objects in File</button>
                <button id="clearFileBtn" class="main-btn stop" disabled>üóëÔ∏è Clear File</button>
            </div>
        </div>

        <!-- Selection Controls (common for both modes) -->
        <div class="control-buttons">
            <button id="selectAllBtn" class="main-btn select-all">Select All Objects</button>
            <button id="deselectAllBtn" class="main-btn deselect-all">Deselect All Objects</button>
        </div>

        <div id="selectedObjectsContainer">
            <span id="selectedCountDisplay">Selected: 0</span>
            <div id="selectedObjectsList" class="hidden"></div>
        </div>

        <div class="categories-container" id="categoriesContainer"></div>

        <div class="objects-grid-popup" id="objectsPopup"></div>
    </div>
</div>

<script>
const categories = {
    'People & Animals': ['person', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe'],
    'Vehicles': ['bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat'],
    'Street Objects': ['traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench'],
    'Accessories': ['backpack', 'umbrella', 'handbag', 'tie', 'suitcase'],
    'Sports': ['frisbee', 'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket'],
    'Kitchen & Dining': ['bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl'],
    'Food': ['banana', 'apple', 'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake'],
    'Furniture': ['chair', 'couch', 'potted plant', 'bed', 'dining table', 'toilet'],
    'Electronics': ['tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'refrigerator'],
    'Other Objects': ['book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush', 'sink']
};

let selectedObjects = new Set();

const categoriesContainer = document.getElementById('categoriesContainer');
const popup = document.getElementById('objectsPopup');
const status = document.getElementById('status');

let activeCategory = null;

// generƒÉm categoriile
Object.entries(categories).forEach(([catName, objects]) => {
    const catDiv = document.createElement('div');
    catDiv.className = 'category';
    catDiv.textContent = catName;
    catDiv.dataset.category = catName;
    categoriesContainer.appendChild(catDiv);

    // Hover ‚Üí afi»ôeazƒÉ popup
    catDiv.addEventListener('mouseover', (e) => {
        activeCategory = catDiv;
        popup.innerHTML = '';

        objects.forEach(obj => {
            const btn = document.createElement('button');
            btn.className = 'object-btn';
            btn.textContent = obj;
            btn.dataset.object = obj;
            if (selectedObjects.has(obj)) btn.classList.add('selected');
            btn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                toggleObject(obj, btn);
            });
            popup.appendChild(btn);
        });

        const rect = catDiv.getBoundingClientRect();
        popup.style.top = rect.bottom + window.scrollY + 'px';
        popup.style.left = rect.left + window.scrollX + 'px';
        popup.style.display = 'flex';
    });

    // Click pe categorie ‚Üí selecteazƒÉ toate / deselecteazƒÉ toate
    catDiv.addEventListener('click', (e) => {
        e.stopPropagation();
        const allSelected = objects.every(obj => selectedObjects.has(obj));

        if (allSelected) {
            objects.forEach(obj => selectedObjects.delete(obj));
            showStatus(`‚ùå Deselected all ${objects.length} from ${catName}`, 'error');
        } else {
            objects.forEach(obj => selectedObjects.add(obj));
            showStatus(`‚úÖ Selected all ${objects.length} from ${catName}`, 'success');
        }

        document.querySelectorAll('.object-btn').forEach(btn => {
            if (objects.includes(btn.dataset.object)) {
                btn.classList.toggle('selected', selectedObjects.has(btn.dataset.object));
            }
        });
    });
});

// popup rƒÉm√¢ne activ c√¢nd treci peste el
popup.addEventListener('mouseover', () => {
    popup.style.display = 'flex';
});

popup.addEventListener('mouseout', () => {
    popup.style.display = 'none';
    activeCategory = null;
});

function toggleObject(obj, btn) {
    if (selectedObjects.has(obj)) {
        selectedObjects.delete(obj);
        btn.classList.remove('selected');
    } else {
        selectedObjects.add(obj);
        btn.classList.add('selected');
    }
}

function showStatus(message, type = 'info') {
    status.textContent = message;
    status.className = 'status ' + type;
    status.style.display = 'block';
    setTimeout(() => status.style.display = 'none', 3000);
}
// ---------------- START/STOP CAMERA ----------------
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const videoFeed = document.getElementById('videoFeed');
const placeholder = document.getElementById('placeholder');

startBtn.addEventListener('click', async () => {
    if (selectedObjects.size === 0) {
        showStatus('‚ö†Ô∏è Please select at least one object before starting.', 'error');
        return;
    }

    const target = Array.from(selectedObjects).join(',');
    videoFeed.src = `/track?target_object=${encodeURIComponent(target)}`;
    videoFeed.style.display = 'block';
    placeholder.style.display = 'none';
    startBtn.disabled = true;
    stopBtn.disabled = false;

    showStatus(`üé• Detecting: ${target}`, 'info');
});

stopBtn.addEventListener('click', async () => {
    await fetch('/stop_camera');
    videoFeed.style.display = 'none';
    placeholder.style.display = 'block';
    videoFeed.src = '';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    showStatus('üõë Detection stopped.', 'error');
});
// ---------------- SELECT/DESELECT ALL ----------------
const selectAllBtn = document.getElementById('selectAllBtn');
const deselectAllBtn = document.getElementById('deselectAllBtn');

selectAllBtn.addEventListener('click', () => {
    Object.values(categories).flat().forEach(obj => selectedObjects.add(obj));
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.add('selected'));
    showStatus('‚úÖ All objects selected', 'success');
});

deselectAllBtn.addEventListener('click', () => {
    selectedObjects.clear();
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.remove('selected'));
    showStatus('‚ùå All objects deselected', 'error');
});
const selectedCountDisplay = document.getElementById('selectedCountDisplay');
const selectedObjectsList = document.getElementById('selectedObjectsList');

// Functie pentru update numar si lista
function updateSelectedDisplay() {
    selectedCountDisplay.textContent = `Selected: ${selectedObjects.size}`;
    
    selectedObjectsList.innerHTML = '';
    selectedObjects.forEach(obj => {
        const span = document.createElement('span');
        span.textContent = obj;
        selectedObjectsList.appendChild(span);
    });
}

// Toggle lista obiecte la click pe numar
selectedCountDisplay.addEventListener('click', () => {
    selectedObjectsList.classList.toggle('hidden');
});

// Apeleaza update dupa selectare/deselectare
function toggleObject(obj, btn) {
    if (selectedObjects.has(obj)) {
        selectedObjects.delete(obj);
        btn.classList.remove('selected');
    } else {
        selectedObjects.add(obj);
        btn.classList.add('selected');
    }
    updateSelectedDisplay();
}

// Dupa click pe select all / deselect all, actualizeaza lista
selectAllBtn.addEventListener('click', () => {
    Object.values(categories).flat().forEach(obj => selectedObjects.add(obj));
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.add('selected'));
    updateSelectedDisplay();
    showStatus('‚úÖ All objects selected', 'success');
});

deselectAllBtn.addEventListener('click', () => {
    selectedObjects.clear();
    document.querySelectorAll('.object-btn').forEach(btn => btn.classList.remove('selected'));
    updateSelectedDisplay();
    showStatus('‚ùå All objects deselected', 'error');
});

const objectSearch = document.getElementById('objectSearch');
const searchResults = document.getElementById('searchResults');

// Lista completa a obiectelor
const allObjects = Object.values(categories).flat();

// Functie pentru afisare rezultate filtrate
objectSearch.addEventListener('input', () => {
    const query = objectSearch.value.toLowerCase();
    searchResults.innerHTML = '';

    if (query === '') {
        searchResults.classList.add('hidden');
        return;
    }

    const filtered = allObjects.filter(obj => obj.toLowerCase().startsWith(query));

    if (filtered.length === 0) {
        searchResults.classList.add('hidden');
        return;
    }

    filtered.forEach(obj => {
        const span = document.createElement('span');
        span.textContent = obj;
        span.addEventListener('click', () => {
            // Adauga obiectul in selectedObjects
            selectedObjects.add(obj);

            // Actualizeaza lista vizibila si butoanele
            document.querySelectorAll('.object-btn').forEach(btn => {
                if (btn.dataset.object === obj) btn.classList.add('selected');
            });
            updateSelectedDisplay();

            // Curata search bar
            objectSearch.value = '';
            searchResults.classList.add('hidden');
        });
        searchResults.appendChild(span);
    });

    searchResults.classList.remove('hidden');
});

// Ascunde rezultatele cand se da click in afara
document.addEventListener('click', (e) => {
    if (!objectSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
    }
});

const darkModeToggle = document.getElementById('darkModeToggle');

darkModeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');

  // schimbƒÉ iconi»õa
  if(document.body.classList.contains('dark-mode')) {
    darkModeToggle.textContent = '‚òÄÔ∏è'; // luminƒÉ
  } else {
    darkModeToggle.textContent = 'üåô'; // √Æntuneric
  }
});
const browseBtn = document.getElementById('browseBtn');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');

let uploadedFile = null;
let isFileMode = false; // Track if we're in file mode or camera mode

browseBtn.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    uploadedFile = file;
    isFileMode = true;

    // Show preview
    const fileType = file.type.startsWith('image/') ? 'image' : 'video';
    const fileURL = URL.createObjectURL(file);

    filePreview.innerHTML = '';

    if (fileType === 'image') {
        const img = document.createElement('img');
        img.src = fileURL;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '300px';
        img.style.borderRadius = '10px';
        filePreview.appendChild(img);
    } else {
        const video = document.createElement('video');
        video.src = fileURL;
        video.controls = true;
        video.style.maxWidth = '100%';
        video.style.maxHeight = '300px';
        video.style.borderRadius = '10px';
        filePreview.appendChild(video);
    }

    const fileName = document.createElement('p');
    fileName.textContent = `üìÅ ${file.name}`;
    fileName.style.marginTop = '10px';
    fileName.style.fontWeight = 'bold';
    filePreview.appendChild(fileName);

    // Hide video feed and show file preview
    videoFeed.style.display = 'none';
    placeholder.style.display = 'none';

    showStatus(`‚úÖ File loaded: ${file.name}`, 'success');
});

startBtn.addEventListener('click', async () => {
    if (selectedObjects.size === 0) {
        showStatus('‚ö†Ô∏è Please select at least one object before starting.', 'error');
        return;
    }

    const target = Array.from(selectedObjects).join(',');

    if (isFileMode && uploadedFile) {
        // Process uploaded file
        startBtn.disabled = true;
        stopBtn.disabled = false;

        showStatus('üîÑ Processing file... Please wait.', 'info');

        const formData = new FormData();
        formData.append('file', uploadedFile);

        try {
            const response = await fetch(`/detect_file?target_object=${encodeURIComponent(target)}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // Clear preview and show result
                filePreview.innerHTML = '';

                if (result.file_type === 'image') {
                    const img = document.createElement('img');
                    img.src = result.output_file + '?t=' + Date.now(); // Add timestamp to avoid cache
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '10px';
                    filePreview.appendChild(img);

                    const info = document.createElement('p');
                    info.innerHTML = `
                        <strong>‚úÖ Detection Complete!</strong><br>
                        Found ${result.count} objects<br>
                        Target objects found: ${result.found_target_objects.join(', ') || 'None'}
                    `;
                    info.style.marginTop = '10px';
                    filePreview.appendChild(info);

                    showStatus(`‚úÖ Detected ${result.count} objects in image`, 'success');
                } else if (result.file_type === 'video') {
                    const video = document.createElement('video');
                    video.src = result.output_file + '?t=' + Date.now();
                    video.controls = true;
                    video.style.maxWidth = '100%';
                    video.style.borderRadius = '10px';
                    filePreview.appendChild(video);

                    const info = document.createElement('p');
                    info.innerHTML = `
                        <strong>‚úÖ Video Processing Complete!</strong><br>
                        Frames processed: ${result.frames_processed}<br>
                        Total detections: ${result.total_detections}<br>
                        Unique objects: ${result.unique_objects}<br>
                        Target objects found: ${result.found_target_objects.join(', ') || 'None'}
                    `;
                    info.style.marginTop = '10px';
                    filePreview.appendChild(info);

                    showStatus(`‚úÖ Processed ${result.frames_processed} frames`, 'success');
                }
            } else {
                showStatus('‚ùå Detection failed', 'error');
            }
        } catch (error) {
            console.error(error);
            showStatus('‚ùå Error processing file', 'error');
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;

    } else {
        // Camera mode
        isFileMode = false;
        filePreview.innerHTML = '';

        videoFeed.src = `/track?target_object=${encodeURIComponent(target)}`;
        videoFeed.style.display = 'block';
        placeholder.style.display = 'none';
        startBtn.disabled = true;
        stopBtn.disabled = false;

        showStatus(`üé• Detecting: ${target}`, 'info');
    }
});

stopBtn.addEventListener('click', async () => {
    if (isFileMode) {
        // Reset file mode
        filePreview.innerHTML = '';
        uploadedFile = null;
        isFileMode = false;
        fileInput.value = '';
        placeholder.style.display = 'block';
    } else {
        // Stop camera
        await fetch('/stop_camera');
        videoFeed.style.display = 'none';
        placeholder.style.display = 'block';
        videoFeed.src = '';
    }

    startBtn.disabled = false;
    stopBtn.disabled = true;

    showStatus('üõë Detection stopped.', 'error');
});


</script>
</body>
</html>
